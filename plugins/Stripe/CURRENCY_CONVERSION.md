# Stripe 多货币选择功能配置指南

## 🌍 功能概述

**多货币选择（Adaptive Pricing）** 功能允许用户在 Stripe 支付页面选择他们偏好的货币进行支付，而无需修改网站显示的价格。

### 使用场景示例：

**场景 1：网站显示人民币，用户可选美元支付**
- 网站显示：**CN¥50.00**
- 支付页面显示：
  ```
  Choose a currency:
  ☑️ CN¥50.00 (人民币)
  ☐ $7.26 (美元)
  ☐ €6.80 (欧元)
  ```

**场景 2：网站显示美元，用户可选人民币支付**
- 网站显示：**$9.99**
- 支付页面显示：
  ```
  Choose a currency:
  ☑️ $9.99 (美元)
  ☐ CN¥72.54 (人民币)
  ```

---

## ⚙️ 配置步骤

### 1. 在插件配置中启用功能

1. 登录 Xboard 管理后台
2. 进入 **插件管理** → **Stripe 支付**
3. 找到 **启用货币选择（多货币显示）** 配置项
4. 选择 **是 - 用户可在支付页面选择货币**
5. 保存配置

### 2. 重新加载 Octane

```bash
php artisan octane:reload
```

### 3. 测试功能

创建一个测试订单，查看支付页面是否出现货币选择选项。

---

## 💰 支持的货币组合

插件会根据您配置的主货币，自动提供以下备选货币：

| 主货币 | 备选货币 | 说明 |
|--------|----------|------|
| **CNY** (人民币) | USD, EUR, HKD | 美元、欧元、港币 |
| **USD** (美元) | CNY, EUR | 人民币、欧元 |
| **EUR** (欧元) | USD, CNY | 美元、人民币 |
| **HKD** (港币) | CNY, USD | 人民币、美元 |
| **GBP** (英镑) | USD, EUR | 美元、欧元 |
| **JPY** (日元) | USD, CNY | 美元、人民币 |
| **SGD** (新币) | USD, CNY | 美元、人民币 |

---

## 🔄 汇率转换机制

### 自动汇率获取

插件会自动从可靠的汇率 API 获取实时汇率：

1. **数据源：** https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/
2. **缓存时间：** 5 分钟
3. **备用方案：** 如果 API 失败，使用固定汇率

### 固定汇率（备用）

当汇率 API 不可用时，系统使用以下固定汇率：

```php
CNY → USD: 0.14  (1人民币 ≈ 0.14美元)
CNY → EUR: 0.13  (1人民币 ≈ 0.13欧元)
CNY → GBP: 0.11  (1人民币 ≈ 0.11英镑)
CNY → HKD: 1.1   (1人民币 ≈ 1.1港币)
CNY → JPY: 20.0  (1人民币 ≈ 20日元)
CNY → SGD: 0.19  (1人民币 ≈ 0.19新币)
```

### 金额计算示例

**场景：网站显示 CN¥50.00，启用多货币选择**

1. **主货币（人民币）：** CN¥50.00
2. **获取实时汇率：** 1 CNY = 0.1375 USD
3. **计算美元金额：** 50 × 0.1375 = 6.875 USD
4. **四舍五入到分：** $6.88
5. **显示给用户：**
   - ☑️ CN¥50.00
   - ☐ $6.88

---

## 📊 支付页面效果

### 启用多货币选择前

```
┌─────────────────────────────────────┐
│  ← 🏢 Your Company                  │
├─────────────────────────────────────┤
│  Premium Links Service              │
│  CN¥50.00                           │
│                                     │
│  [Pay CN¥50.00]                    │
└─────────────────────────────────────┘
```

### 启用多货币选择后

```
┌─────────────────────────────────────┐
│  ← 🏢 Your Company                  │
├─────────────────────────────────────┤
│  Choose a currency:                 │
│  ☑️ 🇨🇳 CN¥50.00                     │
│  ☐ 🇺🇸 $7.26                        │
│  ☐ 🇪🇺 €6.80                        │
│                                     │
│  1 USD = 7.2613 CNY                │
│                                     │
│  Premium Links Service              │
│  CN¥50.00                           │
│                                     │
│  [Pay]                              │
└─────────────────────────────────────┘
```

---

## ✅ 优势和使用场景

### 优势

✅ **提升用户体验**
- 用户可以用熟悉的货币支付
- 无需心算汇率转换

✅ **提高转化率**
- 减少因货币不熟悉导致的放弃支付
- 适合国际化网站

✅ **透明的汇率**
- Stripe 显示实时汇率
- 用户清楚知道支付金额

✅ **自动化处理**
- 无需手动设置多种价格
- 系统自动计算转换金额

### 适用场景

#### 场景 1：面向国内用户的网站，支持外币支付
- 网站显示：人民币
- 支付选项：人民币 / 美元 / 欧元
- 用例：中国用户可以用外币卡支付

#### 场景 2：面向国际用户的网站
- 网站显示：美元
- 支付选项：美元 / 人民币 / 欧元
- 用例：海外用户可以选择本地货币

#### 场景 3：加密货币用户
- 网站显示：人民币
- 支付选项：人民币 / 美元（用于加密货币支付）
- 用例：加密货币支付通常需要美元或欧元

---

## 🔍 常见问题

### Q1: 启用后为什么没有显示货币选择选项？

**A:** 可能的原因：

1. **汇率获取失败**
   - 检查服务器网络连接
   - 查看日志：`tail -f storage/logs/laravel.log | grep "汇率"`

2. **转换后金额太小**
   - 每种货币都有最小金额限制
   - 如果转换后低于最小金额，不会显示该货币

3. **主货币不支持**
   - 检查您配置的货币是否在支持列表中
   - 参考上面的 "支持的货币组合" 表格

### Q2: 如何自定义备选货币？

**A:** 修改 `getCurrencyOptions()` 方法中的 `$currencyPairs` 数组：

```php
$currencyPairs = [
    'CNY' => ['USD', 'EUR', 'HKD'],  // 人民币的备选货币
    // 添加或修改其他货币的配置
];
```

### Q3: 汇率多久更新一次？

**A:** 汇率每 **5 分钟** 更新一次（有缓存）。

如需立即刷新汇率缓存：
```bash
php artisan cache:clear
```

### Q4: 用户选择不同货币后，订单金额会变吗？

**A:** 不会。

- **用户支付：** 按选择的货币金额支付
- **订单记录：** 仍然按主货币记录
- **到账金额：** Stripe 会自动转换为您的账户货币

**示例：**
```
网站显示: CN¥50.00
用户选择: $7.26 (USD)
用户支付: $7.26
订单记录: CN¥50.00
```

### Q5: 会产生额外的货币转换费用吗？

**A:** 可能会。

- **Stripe 费用：** 如果用户选择的货币与您 Stripe 账户的默认货币不同，Stripe 可能收取 **1% 的货币转换费**
- **建议：** 查看 Stripe Dashboard 的费用说明

### Q6: 如何查看用户选择了哪种货币？

**A:** 在日志中可以看到：

```bash
tail -f storage/logs/laravel.log | grep "Checkout"
```

日志示例：
```
[时间] local.INFO: Stripe Checkout会话创建成功
{
    "session_id":"cs_test_...",
    "currency":"cny",
    "payment_method_types":["card","wechat_pay","alipay"],
    "alternative_currencies":["usd","eur"]
}
```

---

## 🛠️ 技术细节

### Stripe API 参数

启用多货币选择后，系统会动态创建 Product 和 Price 对象，然后引用 Price ID：

```php
// 步骤 1: 创建 Product
$product = $stripe->products->create([
    'name' => '订阅服务',
    'description' => 'PremiumLinks - 订单号: xxx',
]);

// 步骤 2: 创建 Price（包含 currency_options）
$price = $stripe->prices->create([
    'product' => $product->id,
    'currency' => 'cny',           // 主货币
    'unit_amount' => 5000,          // 50.00 CNY
    'currency_options' => [
        'usd' => [
            'unit_amount' => 726    // $7.26
        ],
        'eur' => [
            'unit_amount' => 680    // €6.80
        ]
    ],
]);

// 步骤 3: 在 Checkout Session 中引用 Price ID
'line_items' => [
    [
        'price' => $price->id,
        'quantity' => 1
    ]
]
```

**注意**: Stripe API 不支持在 `price_data` 中直接使用 `currency_options`，必须先创建 Price 对象。

### 最小金额限制

每种货币都有 Stripe 规定的最小金额：

| 货币 | 最小金额 | 说明 |
|------|----------|------|
| USD | $0.50 | 50 美分 |
| EUR | €0.50 | 50 欧分 |
| GBP | £0.30 | 30 便士 |
| CNY | ¥3.50 | 3.5 元 |
| HKD | HK$4.00 | 4 港币 |
| JPY | ¥50 | 50 日元 |

---

## 📋 配置检查清单

在启用多货币选择前，请确认：

- [ ] 已在插件配置中启用 "货币选择" 功能
- [ ] 服务器可以访问外部汇率 API
- [ ] 已重新加载 Octane：`php artisan octane:reload`
- [ ] 网站配置的主货币在支持列表中
- [ ] 测试订单金额大于最小金额限制
- [ ] 已查看日志确认功能正常工作

---

## 🎯 最佳实践

### 推荐配置

**场景：中国网站，面向全球用户**

| 配置项 | 推荐值 |
|--------|--------|
| 货币类型 | CNY (人民币) |
| 启用货币选择 | 是 |
| 备选货币 | USD, EUR, HKD |

**效果：**
- 国内用户：用人民币支付
- 海外用户：选择美元或欧元支付
- 香港用户：选择港币支付

---

## 📞 获取帮助

如果遇到问题：

1. **查看日志**
   ```bash
   tail -f storage/logs/laravel.log | grep -i "currency\|汇率"
   ```

2. **测试汇率 API**
   ```bash
   curl "https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/cny.min.json"
   ```

3. **检查 Stripe Dashboard**
   - 查看 Events 日志
   - 确认支付成功时使用的货币

4. **提交问题**
   - GitHub Issues
   - 附上日志和配置信息

---

**版本信息**：v1.3.0+
**更新日期**：2025-01-09
**作者**：Xboard Team
